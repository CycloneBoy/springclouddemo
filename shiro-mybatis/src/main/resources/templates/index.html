<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>layout 后台大布局 - Layui</title>
    <link rel="stylesheet" href="../../css/layui.css" th:href="@{/layui/css/layui.css}">

    <!-- 新 Bootstrap4 核心 CSS 文件 -->
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}"
          href="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/css/bootstrap.min.css">

    <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
    <script th:src="@{/js/jquery.min.js}" src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>

    <!-- popper.min.js 用于弹窗、提示、下拉菜单 -->
    <script th:src="@{/js/popper.min.js}" src="https://cdn.staticfile.org/popper.js/1.12.5/umd/popper.min.js"></script>

    <!-- 最新的 Bootstrap4 核心 JavaScript 文件 -->
    <script th:src="@{/js/bootstrap.min.js}"
            src="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/js/bootstrap.min.js"></script>

</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">

<div th:include="fragments/nav :: nav"></div>

    <div class="layui-body container">

        <div class="demoTable">
            按模板名称搜索：
            <div class="layui-inline">
                <input class="layui-input" id="demoReload"  name="keyword" autocomplete="off">
            </div>
            <button class="layui-btn" data-type="reload">搜索</button>
        </div>


        <table id="demo" lay-filter="test"></table>

        <!--编辑-->
        <script type="text/html" id="toolbarDemo">
            <div class="layui-btn-container">
                <button class="layui-btn layui-btn-sm" lay-event="getCheckData">获取选中行数据</button>
                <button class="layui-btn layui-btn-sm" lay-event="getCheckLength">获取选中数目</button>
                <button class="layui-btn layui-btn-sm" lay-event="isAll">验证是否全选</button>
            </div>
        </script>

        <script type="text/html" id="barDemo">
            <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">添加</a>
            <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
            <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
        </script>



    </div>
<div th:include="fragments/footer :: footer"></div>
</div>

<!--添加或编辑用户-->
<div id="setUser" class="layer_self_wrap" style="display:none;">
    <form id="userForm" class="layui-form layui-form-pane" method="post" action="" style="margin-top: 20px;">
        <input id="id" type="hidden" name="id"/>
        <div class="layui-form-item">
            <label class="layui-form-label">用户名</label>
            <div class="layui-input-inline">
                <input id="username" name="username" lay-verify="required" autocomplete="off" class="layui-input" type="text"/>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">密码</label>
            <div class="layui-input-inline">
                <input id="password" name="password" autocomplete="off" class="layui-input" type="password"
                       placeholder="默认密码：123456" />
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">姓名</label>
            <div class="layui-input-inline">
                <input id="name" name="name" lay-verify="required" autocomplete="off" class="layui-input"
                       type="text"/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">状态</label>
            <div class="layui-input-block">
                <input  type="radio" name="state" value="0" title="无效" checked>
                <input  type="radio" name="state" value="1" title="有效" >
            </div>
        </div>

        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">描述</label>
            <div class="layui-input-block">
                <textarea name="description" placeholder="请输入描述" class="layui-textarea"></textarea>
            </div>
        </div>

        <div class="layui-form-item">
            <div class="layui-input-block" style="margin-left: 10px;">
                <button class="layui-btn"  lay-submit="" lay-filter="userSubmit">提交</button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </form>
</div>

<script src="../js/layui.js" th:src="@{/layui/layui.js}"></script>
<script  th:inline="none">
    layui.use(['table','layer','form'], function(){
        var table = layui.table;
        var layer = layui.layer;
        var form = layui.form;

        //展示数据表格
        table.render({
            elem: '#demo'
            ,url: '/user/userList' //数据接口
            ,height: 400
            ,toolbar: '#toolbarDemo'
            ,title: '用户数据表'
            ,page: true //开启分页
            ,cols: [[ //表头
                {type: 'checkbox', fixed: 'left'}
                ,{field: 'id', title: 'ID', width:80, sort: true, fixed: 'left'}
                ,{field: 'username', title: '用户名', width:80}
                ,{field: 'name', title: '名称', width:80}
                ,{field: 'password', title: '密码', width:200, sort: true}
                ,{field: 'salt', title: '盐', width:200}
                ,{field: 'state', title: '状态', width: 80}
                ,{field: 'description', title: '描述', width: 80, sort: true}
                ,{fixed: 'right', title:'操作', toolbar: '#barDemo', width:150}
            ]]
        });

        //搜索 ----------------------------------------------- Begin-----------------------------------------------------------
        var $ = layui.$, active =
            {
                reload: function () {
                    var demoReload = $('#demoReload').val();//获取输入框的值
                    //执行重载
                    table.reload('test',
                        {
                            page:
                                {
                                    curr: 1 //重新从第 1 页开始
                                }
                            , where: { name: demoReload}//这里传参  向后台
                            , url: '/Home/Temp_search'//后台做模糊搜索接口路径
                            , method: 'post'
                        });
                }
            };
        //这个是用于创建点击事件的实例
        $('.demoTable .layui-btn').on('click', function ()
        {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
        //搜索 ----------------------------------------------- End-----------------------------------------------------------

        //监听工具条 ----------------------------------------------- Begin-----------------------------------------------------------
        table.on('tool(test)', function (obj) {    //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
            var tr = obj.tr; //获得当前行 tr 的DOM对象
            if (layEvent == 'detail'){
                // layer.msg('ID: ' + data.id + ' 的查看操作');

                layer.open(
                    {
                        type: 1,
                        title: '用户信息添加页面',
                        shadeClose: true,
                        shade: 0.8,
                        // area: ['880px', '550px'],
                        content: $('#setUser'),//跳转的页面
                        cancel: function (index)
                        {
                            $(".layui-laypage-btn").click();//这里用于关闭Open时触发回调函数  刷新父页面数据  一定要引入Jquery
                        }

                    });


            }else if (layEvent == 'edit')
            {
                layer.open(
                    {
                        type: 1,
                        title: '用户信息编辑页面',
                        shadeClose: true,
                        shade: 0.8,
                        // area: ['880px', '550px'],
                        content: $('#setUser'),//跳转的页面
                        cancel: function (index)
                        {
                            $(".layui-laypage-btn").click();//这里用于关闭Open时触发回调函数  刷新父页面数据  一定要引入Jquery
                        },
                        yes:function (index,layero) {
                            console.info("yes: " + index + " " + layero)
                        }

                    });

                form.val( 'userForm',data);

                form.render();

                //注：在这里我不就做修改界面了  这里这只是一个弹出框  弹出你的修改页面  Content中你自定义自己的页面路径并传参数
            } else if (layEvent == 'del') //删除数据
            {
                // layer.confirm('真的删除行么', function(index){
                //     console.log(data);
                //     $.ajax({
                //         url: "/Home/DeleteInfoById",
                //         type: "POST",
                //         data:{"uvid":data.id,"memthodname":"deleteuv","id": data.UserId},
                //         dataType: "json",
                //         success: function(data){
                //
                //             if(data.state==1){
                //                 //删除这一行
                //                 obj.del();
                //                 //关闭弹框
                //                 layer.close(index);
                //                 layer.msg("删除成功", {icon: 6});
                //             }else{
                //                 layer.msg("删除失败", {icon: 5});
                //             }
                //         }
                //
                //     });
                // });

                //删除数据在这里可以使用Ajax异步  就和平常使用一样简单
                $.post("/Home/DeleteInfoById", { id: data.id }, function (ret)
                {
                    if (ret.code == "1") {
                        layer.msg(ret.msg, { icon: 1, time: 1500 }, function () {
                            obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                            $(".layui-laypage-btn").click();
                        });
                    } else
                    {
                        layer.msg(ret.msg, { icon: 2, time: 1500 });
                    }
                });

            }
        });

        //监听工具条 ----------------------------------------------- ENd-----------------------------------------------------------





        //头工具栏事件
        table.on('toolbar(test)', function(obj){
            var checkStatus = table.checkStatus(obj.config.id);
            switch(obj.event){
                case 'getCheckData':
                    var data = checkStatus.data;
                    layer.alert(JSON.stringify(data));
                    break;
                case 'getCheckLength':
                    var data = checkStatus.data;
                    layer.msg('选中了：'+ data.length + ' 个');
                    break;
                case 'isAll':
                    layer.msg(checkStatus.isAll ? '全选': '未全选');
                    break;
            };
        });

        form.on('submit(userSubmit)', function(data){
            console.log(data.elem) //被执行事件的元素DOM对象，一般为button对象
            console.log(data.form) //被执行提交的form对象，一般在存在form标签时才会返回
            console.log(data.field) //当前容器的全部表单字段，名值对形式：{name: value}
            return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
        });
    });


</script>
</body>
</html>